---
- name: Install KVM setup
  hosts: all
  become: true
  connection: local
  tasks:
    - name: Install dependencies
      community.general.pacman:
        name:
          - qemu
          - libvirt
          - edk2-ovmf
          - virt-manager
          - swtpm
          - iptables-nft
          - dnsmasq
          - virt-viewer 
          - vde2 
          - bridge-utils 
          - openbsd-netcat 
          - ebtables 
          - libguestfs
    - name: Enable libvirtd
      ansible.builtin.systemd:
        name: libvirtd
        state: started
        enabled: true
    - name: Enable virtlogd
      ansible.builtin.systemd:
        name: virtlogd
        state: started
        enabled: true
    - name: Enable unix_sock_group = "libvirt"
      ansible.builtin.lineinfile:
        path: /etc/libvirt/libvirtd.conf
        regexp: '^unix_sock_group '
        insertafter: '^#unix_sock_group '
        line: 'unix_sock_group = "libvirt"'
    - name: Enable unix_sock_rw_perms = "0770"
      ansible.builtin.lineinfile:
        path: /etc/libvirt/libvirtd.conf
        regexp: '^unix_sock_rw_perms '
        insertafter: '^#unix_sock_rw_perms '
        line: 'unix_sock_rw_perms = "0770"'
    - name: Add the user {{ lookup('env', 'USER') }} to libvirt-qemu group
      ansible.builtin.user:
        name: "{{ lookup('env', 'USER') }}"
        groups: libvirt-qemu
        append: yes
